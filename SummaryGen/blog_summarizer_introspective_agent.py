from llama_index.agent.introspective import IntrospectiveAgentWorker, ToolInteractiveReflectionAgentWorker, \
    SelfReflectionAgentWorker
from llama_index.core.llms import ChatMessage, MessageRole
from SummaryGen.blog_summarizer import DocumentSummaryGenerator
from llama_index.core.tools import FunctionTool
from llama_index.core.tools import QueryEngineTool
from deepeval.metrics import SummarizationMetric, HallucinationMetric
from deepeval.test_case import LLMTestCase
from Tests.deep_eval_custom_model import CustomEvaluationModel
from SummaryGen.llm_model_provider import LLMProvider
from Tests.config_test import Config as testconfig
from config import Config
import os
from dotenv import load_dotenv

root_dir = os.path.dirname(os.path.dirname(__file__))
load_dotenv(root_dir + '/.envfile')

custom_eval_llm_model = CustomEvaluationModel(model=LLMProvider(**testconfig['eval_model_args']).get_llm_model())


def deepeval_summary_scorer(input_str, output_str):
    summarization_metric = SummarizationMetric(threshold=0.5, model=custom_eval_llm_model, assessment_questions=[
        "Is the coverage score based on a percentage of 'yes' answers?",
        "Does the score ensure the summary's accuracy with the source?",
        "Does a higher score mean a more comprehensive summary?"
    ])
    summarization_metric.measure(test_case=LLMTestCase(input=input_str, actual_output=output_str))
    return summarization_metric.score


def deepeval_hallucination_scorer(input_str, context_str, output_str):
    hallucination_metric = HallucinationMetric(threshold=0.0, model=custom_eval_llm_model)
    hallucination_metric.measure(test_case=LLMTestCase(input=input_str, actual_output=output_str, context=context_str))
    return hallucination_metric.score


hallucination_tool = FunctionTool.from_defaults(deepeval_hallucination_scorer, )


def get_introspective_agent_with_self_reflection(
        verbose=True, with_main_worker=True
):
    """Helper function for building introspective agent using self reflection.

    Steps:

    1. Define the `SelfReflectionAgentWorker`
        1a. Construct `SelfReflectionAgentWorker` using .from_defaults()

    2. Optionally define a `MainAgentWorker`

    3. Construct `IntrospectiveAgent`
        3a. Construct `IntrospectiveAgentWorker` using .from_defaults()
        3b. Construct `IntrospectiveAgent` using .as_agent()
    """

    # 1a.
    self_reflection_agent_worker = SelfReflectionAgentWorker.from_defaults(
        llm=LLMProvider(**testconfig['eval_model_args']).get_llm_model(),
        verbose=verbose,
    )

    # 2.
    if with_main_worker:
        query_engine = DocumentSummaryGenerator(**Config['summarizer_args'], **Config['query_engine_args']).query_engine
        main_agent_worker = QueryEngineTool(query_engine = query_engine)

    else:
        main_agent_worker = None

    # 3a.
    introspective_worker_agent = IntrospectiveAgentWorker.from_defaults(
        reflective_agent_worker=self_reflection_agent_worker,
        main_agent_worker=main_agent_worker,
        verbose=verbose,
    )

    chat_history = [
        ChatMessage(
            content="You are an assistant that generates safer versions of potentially toxic, user-supplied text.",
            role=MessageRole.SYSTEM,
        )
    ]

    # 3b.
    return introspective_worker_agent.as_agent(
        chat_history=chat_history, verbose=verbose
    )


if __name__ == '__main__':
    introspective_agent = get_introspective_agent_with_self_reflection(
        verbose=True
    )
    response = introspective_agent.chat('10 Expert Tips to Optimize Your Resume and Get Past the ATS')
    a = hallucination_tool(
        input_str='The contents of a blog titled Cracking the Code of ATS - 10 Tips to Optimize Your Resume are provided as Context information below.\n---------------------\n10 Expert Tips to Optimize Your Resume and Get Past the ATS\nHave you heard about companies ditching recruiters and using technology to manage the hiring process?\nWell… while there’s some smoke to the fire, the rumor isn’t quite true.\nRecruiters aren’t losing their jobs. Instead, many companies are cutting out the first step, using technology to handle the initial filtering process instead of hiring specialists.\nApplicant Tracking Systems (ATS)\nThis technology is called an Applicant Tracking System or ATS.\nThis is how it works. The hiring manager identifies major hard skill keywords and criteria that they think are important in the job vacancy they want filled. This might include certain knowledge areas, specific qualifications, or a particular length of experience.\nThis info is put into the ATS. Then when someone applies online, the ATS automatically screens your resume against the requirements and tells the recruiter how closely you match.\nSounds great, right? The trouble is, many people don’t edit their resume to show how their experience and skills match what the company is looking for. Then they get upset when they get rejected. They might even blame the technology.  But how will the ATS - or a recruiter - know you have it if it’s not there?\nOver 90% of medium- to large-sized organizations use ATS. They’re a lot more efficient at quickly identifying good fits.\nBut even if the company isn’t using an ATS, their hiring managers are still looking for the exact same things in your resume.\nIn this blog post, we’ll share 10 immediately actionable tips that you can use to get your resume through the ATS and in front of recruiters.\n10 Tips To ‘Beat’ the ATS\nTip #1\nMost ATS are designed to read resumes left to right, line-by-line. So that means a clean, simple, one-column style works best. Which leads us to Tip #2…\nTip #2\nAvoid creative resumes. ATS often struggle with these because of all the design elements. That means no columns, no text boxes, no fancy graphics if you want to avoid ‘reading’ errors. In fact, 21% of resumes submitted through an ATS include features that are unreadable to the software.\nTip #3\nATS can’t read between the lines, either.\n\nThat means no columns, no text boxes, no fancy graphics if you want to avoid ‘reading’ errors. In fact, 21% of resumes submitted through an ATS include features that are unreadable to the software.\nTip #3\nATS can’t read between the lines, either. If you have the required skills and meet the essential criteria, state it explicitly, using the same wording. If the ATS doesn’t flag you as a good fit, your application may never land in front of the recruiter.\nTip #4\nLinked to #3, ATS rate the hard skill keyword match between your resume and the job posting (soft skills, not so much). So, be sure to identify key hard skills mentioned in the job vacancy and incorporate them strategically into your resume.\nTip #5\nYou can’t trick ATS! You’ll see lots of advice on the internet encouraging you to ‘keyword stuff’ or hide extra keywords in (invisible) white font in your resume, so the ATS thinks you’re a good fit. Don’t. Not only will you get rejected once the recruiter sees that you don’t actually have the experience, but it wastes their time (and yours). If you have the skills, include them. If you don’t, look for better-fitting opportunities.\nTip #6\nIt might sound great to use creative headings (e.g. “Snapshot” instead of “Summary”) to stand out. But standard headings such as “Work Experience,” “Education”, and “Skills” ensure the ATS can effectively navigate your resume, ensuring all relevant information is accurately assessed and ranked.\nTip #7\nCheck your spelling: a misspelled skill can’t be ‘read’ by ATS. It may sound obvious, but carefully review your resume for spelling (and grammar) errors, especially crucial keywords. ATS rely on precise language to interpret and rank resumes accurately.\nTip #8\nInclude a key skills section in your resume to quickly tweak it for specific jobs. As mentioned, ATS sort and rank your application according to how closely it matches the key skills and criteria in the job posting. Although you should also have relevant skills sprinkled naturally throughout your resume, a key skills box ensures a precise match with the job posting’s language AND makes it easier to quickly edit your resume for each job you apply for.\n\nAlthough you should also have relevant skills sprinkled naturally throughout your resume, a key skills box ensures a precise match with the job posting’s language AND makes it easier to quickly edit your resume for each job you apply for.\nTip #9\nWrite out acronyms and abbreviations so ATS can check for both. For example, a recruiter may be looking for someone with the ‘Project Management Professional’ qualification. But if you just put PMP, the ATS may not have been asked to look for this acronym. Include both versions to ensure you’re not overlooked either way.\nTip #10\nATS ‘read’ Word documents better than PDF. While many ATS can handle both Word and PDFs, the less sophisticated ones may struggle to parse PDFs correctly. So unless stated otherwise in the job posting, use Word for online applications.\nConclusion\nApplicant Tracking Systems (ATS) are nothing to be worried about. There’s really no rocket science behind the technology – they’re essentially looking for the exact same thing as recruiters (and no, they’re not replacing them!).\nBy tailoring your resume to ensure it (relevantly) includes the hard skills and essential criteria mentioned in the job posting, it’s more likely to rank higher when the ATS or recruiter reviews your application.\nThe 10 tips in this blog post will help you to optimize your resume quickly and with better results.\nKey takeaways:\n\n\nDespite rumors, recruiters aren’t losing their jobs: many companies leverage Applicant Tracking Systems (ATS) to simplify the initial resume screening process, making it more efficient and effective\n\n\nAn ATS is recruitment software that automatically screens resumes against specific criteria and keywords set by recruiters. It ranks applicants based on how closely they match the requirements\n\n\n‘Beat’ the ATS by tailoring your resume to match job requirements: Many applicants get rejected because they fail to showcase how their skills and experience align with the company’s needs. Customizing your resume to reflect the job’s hard skill keywords significantly improves your chances of passing through ATS and catching the recruiter’s attention\n\n\nATS often struggle with creative resumes, so stick to a simple, single-column format. Avoid using text boxes, fancy graphics, and multiple columns that may cause parsing errors\n\nATS often struggle with creative resumes, so stick to a simple, single-column format. Avoid using text boxes, fancy graphics, and multiple columns that may cause parsing errors\n\n\nAvoid keyword stuffing: Attempting to trick ATS by overloading your resume with irrelevant keywords or hiding them in white font is not a smart move. Many ATS can detect this! It not only leads to rejection, but also wastes the recruiter’s (and your) time.\n\n\nUsing standard headings (e.g., “Work Experience,” “Education,” “Skills”) ensures that ATS can ‘read’ and categorise your resume sections correctly.\n\n\nDon’t forget to check for spelling errors: ATS rely on precise language for accurate resume assessment\n\n\nExplore more articles\n\n\nWhy do companies want experience for entry-level roles?\nCraft a Fulfilling Career with Your Personal Memento Mori\n10 Tips That Recruiters Really, Really Want Job Seekers to Know\n10 Unconventional Jobs to Inspire Your Career Pivot in 2024\n8 Top Freelance Websites to Kick-Start Your Solo Career\nWhy JobLeads is Your Career Services Netflix\n7 Benefits of Choosing Escape Room Training for Team Building\nStrategic Job Hopping - 4 Steps for Advancing Your Career\nHow to Use ChatGPT to Write The Perfect Cover Letter\n6 Effective Methods to Learn and Upskill While Sleeping\n---------------------\nGiven the information and not prior knowledge, summarize the blog.\nSummary: ',
        output_str=' The blog titled \"10 Expert Tips to Optimize Your Resume and Get Past the ATS\" discusses the increasing use of Applicant Tracking Systems (ATS) by companies in their hiring process. These systems automatically screen resumes against required skills and criteria set by hiring managers. The blog aims to help job applicants increase their chances of passing through the ATS and reaching recruiters by providing the following tips:\n\n1. Use a simple, one-column resume format.\n2. Avoid creative resumes with design elements that may cause reading errors.\n3. State required skills and criteria explicitly in the resume.\n4. Identify and incorporate key hard skills from the job posting.\n5. Do not attempt to trick the ATS with keyword stuffing or hidden keywords.\n6. Use standard headings for easy navigation and assessment.\n7. Check for spelling errors, especially of crucial keywords.\n8. Include a key skills section to match the job posting\'s language and facilitate editing.\n9. Write out acronyms and abbreviations for better matching.\n10. Submit Word documents instead of PDFs for more reliable parsing.\n\nThe blog emphasizes the importance of tailoring resumes to match job requirements and ensuring the ATS can accurately assess and rank them. Recruiters are not being replaced by ATS, but rather, these systems help streamline the initial resume screening process.',
        context_str=[
            '10 Expert Tips to Optimize Your Resume and Get Past the ATS\nHave you heard about companies ditching recruiters and using technology to manage the hiring process?\nWell… while there’s some smoke to the fire, the rumor isn’t quite true.\nRecruiters aren’t losing their jobs. Instead, many companies are cutting out the first step, using technology to handle the initial filtering process instead of hiring specialists.\nApplicant Tracking Systems (ATS)\nThis technology is called an Applicant Tracking System or ATS.\nThis is how it works. The hiring manager identifies major hard skill keywords and criteria that they think are important in the job vacancy they want filled. This might include certain knowledge areas, specific qualifications, or a particular length of experience.\nThis info is put into the ATS. Then when someone applies online, the ATS automatically screens your resume against the requirements and tells the recruiter how closely you match.\nSounds great, right? The trouble is, many people don’t edit their resume to show how their experience and skills match what the company is looking for. Then they get upset when they get rejected. They might even blame the technology.  But how will the ATS - or a recruiter - know you have it if it’s not there?\nOver 90% of medium- to large-sized organizations use ATS. They’re a lot more efficient at quickly identifying good fits.\nBut even if the company isn’t using an ATS, their hiring managers are still looking for the exact same things in your resume.\nIn this blog post, we’ll share 10 immediately actionable tips that you can use to get your resume through the ATS and in front of recruiters.\n10 Tips To ‘Beat’ the ATS\nTip #1\nMost ATS are designed to read resumes left to right, line-by-line. So that means a clean, simple, one-column style works best. Which leads us to Tip #2…\nTip #2\nAvoid creative resumes. ATS often struggle with these because of all the design elements. That means no columns, no text boxes, no fancy graphics if you want to avoid ‘reading’ errors. In fact, 21% of resumes submitted through an ATS include features that are unreadable to the software.\nTip #3\nATS can’t read between the lines, either.\n\nThat means no columns, no text boxes, no fancy graphics if you want to avoid ‘reading’ errors. In fact, 21% of resumes submitted through an ATS include features that are unreadable to the software.\nTip #3\nATS can’t read between the lines, either. If you have the required skills and meet the essential criteria, state it explicitly, using the same wording. If the ATS doesn’t flag you as a good fit, your application may never land in front of the recruiter.\nTip #4\nLinked to #3, ATS rate the hard skill keyword match between your resume and the job posting (soft skills, not so much). So, be sure to identify key hard skills mentioned in the job vacancy and incorporate them strategically into your resume.\nTip #5\nYou can’t trick ATS! You’ll see lots of advice on the internet encouraging you to ‘keyword stuff’ or hide extra keywords in (invisible) white font in your resume, so the ATS thinks you’re a good fit. Don’t. Not only will you get rejected once the recruiter sees that you don’t actually have the experience, but it wastes their time (and yours). If you have the skills, include them. If you don’t, look for better-fitting opportunities.\nTip #6\nIt might sound great to use creative headings (e.g. “Snapshot” instead of “Summary”) to stand out. But standard headings such as “Work Experience,” “Education”, and “Skills” ensure the ATS can effectively navigate your resume, ensuring all relevant information is accurately assessed and ranked.\nTip #7\nCheck your spelling: a misspelled skill can’t be ‘read’ by ATS. It may sound obvious, but carefully review your resume for spelling (and grammar) errors, especially crucial keywords. ATS rely on precise language to interpret and rank resumes accurately.\nTip #8\nInclude a key skills section in your resume to quickly tweak it for specific jobs. As mentioned, ATS sort and rank your application according to how closely it matches the key skills and criteria in the job posting. Although you should also have relevant skills sprinkled naturally throughout your resume, a key skills box ensures a precise match with the job posting’s language AND makes it easier to quickly edit your resume for each job you apply for.\n\nAlthough you should also have relevant skills sprinkled naturally throughout your resume, a key skills box ensures a precise match with the job posting’s language AND makes it easier to quickly edit your resume for each job you apply for.\nTip #9\nWrite out acronyms and abbreviations so ATS can check for both. For example, a recruiter may be looking for someone with the ‘Project Management Professional’ qualification. But if you just put PMP, the ATS may not have been asked to look for this acronym. Include both versions to ensure you’re not overlooked either way.\nTip #10\nATS ‘read’ Word documents better than PDF. While many ATS can handle both Word and PDFs, the less sophisticated ones may struggle to parse PDFs correctly. So unless stated otherwise in the job posting, use Word for online applications.\nConclusion\nApplicant Tracking Systems (ATS) are nothing to be worried about. There’s really no rocket science behind the technology – they’re essentially looking for the exact same thing as recruiters (and no, they’re not replacing them!).\nBy tailoring your resume to ensure it (relevantly) includes the hard skills and essential criteria mentioned in the job posting, it’s more likely to rank higher when the ATS or recruiter reviews your application.\nThe 10 tips in this blog post will help you to optimize your resume quickly and with better results.\nKey takeaways:\n\n\nDespite rumors, recruiters aren’t losing their jobs: many companies leverage Applicant Tracking Systems (ATS) to simplify the initial resume screening process, making it more efficient and effective\n\n\nAn ATS is recruitment software that automatically screens resumes against specific criteria and keywords set by recruiters. It ranks applicants based on how closely they match the requirements\n\n\n‘Beat’ the ATS by tailoring your resume to match job requirements: Many applicants get rejected because they fail to showcase how their skills and experience align with the company’s needs. Customizing your resume to reflect the job’s hard skill keywords significantly improves your chances of passing through ATS and catching the recruiter’s attention\n\n\nATS often struggle with creative resumes, so stick to a simple, single-column format. Avoid using text boxes, fancy graphics, and multiple columns that may cause parsing errors\n\nATS often struggle with creative resumes, so stick to a simple, single-column format. Avoid using text boxes, fancy graphics, and multiple columns that may cause parsing errors\n\n\nAvoid keyword stuffing: Attempting to trick ATS by overloading your resume with irrelevant keywords or hiding them in white font is not a smart move. Many ATS can detect this! It not only leads to rejection, but also wastes the recruiter’s (and your) time.\n\n\nUsing standard headings (e.g., “Work Experience,” “Education,” “Skills”) ensures that ATS can ‘read’ and categorise your resume sections correctly.\n\n\nDon’t forget to check for spelling errors: ATS rely on precise language for accurate resume assessment\n\n\nExplore more articles\n\n\nWhy do companies want experience for entry-level roles?\nCraft a Fulfilling Career with Your Personal Memento Mori\n10 Tips That Recruiters Really, Really Want Job Seekers to Know\n10 Unconventional Jobs to Inspire Your Career Pivot in 2024\n8 Top Freelance Websites to Kick-Start Your Solo Career\nWhy JobLeads is Your Career Services Netflix\n7 Benefits of Choosing Escape Room Training for Team Building\nStrategic Job Hopping - 4 Steps for Advancing Your Career\nHow to Use ChatGPT to Write The Perfect Cover Letter\n6 Effective Methods to Learn and Upskill While Sleeping']
    )
    print(a)
